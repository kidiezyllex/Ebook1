<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word to Chapters Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
        }

        .upload-section.dragover {
            border-color: #764ba2;
            background: #f0f0ff;
        }

        input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .upload-btn:hover {
            transform: scale(1.05);
        }

        .preview-section {
            margin-top: 30px;
        }

        .preview-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .preview-content {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            background: #f9f9f9;
        }

        .chapter-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .chapter-title {
            font-weight: bold;
            color: #667eea;
            font-size: 18px;
        }

        .chapter-controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-export {
            background: #27ae60;
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            width: 100%;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .chapter-content {
            color: #666;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .editable {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 14px;
        }

        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 5px;
        }

        .export-code {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: #2d2d2d;
            color: #f8f8f2;
            overflow-x: auto;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Word to Chapters Converter</h1>
        
        <div class="upload-section" id="uploadSection">
            <p style="margin-bottom: 20px; color: #666;">Upload file Word (.docx) ƒë·ªÉ chuy·ªÉn ƒë·ªïi th√†nh chapters</p>
            <input type="file" id="fileInput" accept=".docx" />
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Ch·ªçn file Word
            </button>
            <p style="margin-top: 15px; color: #999; font-size: 14px;">Ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</p>
        </div>

        <div id="status"></div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <div class="progress-text" id="progressText">ƒêang x·ª≠ l√Ω...</div>
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
            <h2>Preview v√† Ch·ªânh s·ª≠a Chapters</h2>
            <div id="chaptersList"></div>
        </div>

        <div class="export-section" id="exportSection" style="display: none;">
            <h2>Export Code</h2>
            <textarea class="export-code" id="exportCode" readonly></textarea>
            <button class="btn btn-export" onclick="copyToClipboard()">Copy Code</button>
        </div>
    </div>

    <script>
        let chapters = [];
        let currentFile = null;

        const uploadSection = document.getElementById('uploadSection');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.docx')) {
                handleFile(files[0]);
            }
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            currentFile = file;
            showStatus('ƒêang x·ª≠ l√Ω file...', 'loading');
            showProgress(0, 'ƒêang ƒë·ªçc file Word...');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                showProgress(20, 'ƒêang chuy·ªÉn ƒë·ªïi sang HTML...');
                
                const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                
                if (result.messages.length > 0) {
                    console.warn('Warnings:', result.messages);
                }

                showProgress(40, 'ƒêang ph√¢n t√≠ch n·ªôi dung...');
                
                // Parse HTML v√† detect chapters v·ªõi progress
                chapters = await parseChaptersWithProgress(result.value);
                
                if (chapters.length === 0) {
                    hideProgress();
                    showStatus('Kh√¥ng t√¨m th·∫•y chapter n√†o. Vui l√≤ng ki·ªÉm tra l·∫°i file Word.', 'error');
                    return;
                }

                showProgress(100, `Ho√†n th√†nh! ƒê√£ t√¨m th·∫•y ${chapters.length} chapter(s)`);
                
                setTimeout(() => {
                    hideProgress();
                    showStatus(`ƒê√£ t√¨m th·∫•y ${chapters.length} chapter(s)`, 'success');
                }, 500);
                
                displayChapters();
                generateExportCode();
                
            } catch (error) {
                hideProgress();
                showStatus('L·ªói khi x·ª≠ l√Ω file: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function parseChaptersWithProgress(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const elements = doc.body.children;
            
            const chapters = [];
            let currentChapter = null;
            let pageNumber = 1;
            const totalElements = elements.length;

            for (let i = 0; i < elements.length; i++) {
                const el = elements[i];
                const text = el.textContent.trim();
                
                // Update progress
                const progress = 40 + Math.floor((i / totalElements) * 50); // 40-90%
                const currentPage = currentChapter ? pageNumber : pageNumber + 1;
                showProgress(progress, `ƒêang x·ª≠ l√Ω trang ${currentPage}... (${i + 1}/${totalElements} ph·∫ßn t·ª≠)`);
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 10));
                
                if (!text) continue;

                // Detect chapter headings (h1, h2, ho·∫∑c text c√≥ ch·ª©a "CH∆Ø∆†NG", "TRANG", "L·ªúI", etc.)
                const isHeading = el.tagName.match(/^H[1-6]$/i) || 
                                 text.match(/^(CH∆Ø∆†NG|TRANG|L·ªúI|GI·ªöI THI·ªÜU|M·ª§C L·ª§C|K·∫æT C·∫§U)/i);
                
                if (isHeading && currentChapter) {
                    // Save previous chapter
                    chapters.push(currentChapter);
                    pageNumber++;
                }

                if (isHeading) {
                    // Start new chapter
                    currentChapter = {
                        id: generateId(text),
                        page: String(pageNumber),
                        title: text.toUpperCase(),
                        content: ''
                    };
                } else if (currentChapter) {
                    // Add content to current chapter
                    if (currentChapter.content) {
                        currentChapter.content += '\n\n';
                    }
                    currentChapter.content += text;
                } else {
                    // Create new chapter for orphaned content
                    currentChapter = {
                        id: `trang-${pageNumber}`,
                        page: String(pageNumber),
                        title: `TRANG ${pageNumber}`,
                        content: text
                    };
                }
            }

            // Save last chapter
            if (currentChapter) {
                chapters.push(currentChapter);
            }

            return chapters;
        }

        function parseChapters(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const elements = doc.body.children;
            
            const chapters = [];
            let currentChapter = null;
            let pageNumber = 1;

            for (let i = 0; i < elements.length; i++) {
                const el = elements[i];
                const text = el.textContent.trim();
                
                if (!text) continue;

                // Detect chapter headings (h1, h2, ho·∫∑c text c√≥ ch·ª©a "CH∆Ø∆†NG", "TRANG", "L·ªúI", etc.)
                const isHeading = el.tagName.match(/^H[1-6]$/i) || 
                                 text.match(/^(CH∆Ø∆†NG|TRANG|L·ªúI|GI·ªöI THI·ªÜU|M·ª§C L·ª§C|K·∫æT C·∫§U)/i);
                
                if (isHeading && currentChapter) {
                    // Save previous chapter
                    chapters.push(currentChapter);
                    pageNumber++;
                }

                if (isHeading) {
                    // Start new chapter
                    currentChapter = {
                        id: generateId(text),
                        page: String(pageNumber),
                        title: text.toUpperCase(),
                        content: ''
                    };
                } else if (currentChapter) {
                    // Add content to current chapter
                    if (currentChapter.content) {
                        currentChapter.content += '\n\n';
                    }
                    currentChapter.content += text;
                } else {
                    // Create new chapter for orphaned content
                    currentChapter = {
                        id: `trang-${pageNumber}`,
                        page: String(pageNumber),
                        title: `TRANG ${pageNumber}`,
                        content: text
                    };
                }
            }

            // Save last chapter
            if (currentChapter) {
                chapters.push(currentChapter);
            }

            return chapters;
        }

        function generateId(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '-')
                .substring(0, 50);
        }

        function displayChapters() {
            const chaptersList = document.getElementById('chaptersList');
            chaptersList.innerHTML = '';
            
            chapters.forEach((chapter, index) => {
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'chapter-item';
                chapterDiv.innerHTML = `
                    <div class="chapter-header">
                        <span class="chapter-title">${chapter.title} (Trang ${chapter.page})</span>
                        <div class="chapter-controls">
                            <button class="btn btn-edit" onclick="editChapter(${index})">S·ª≠a</button>
                            <button class="btn btn-delete" onclick="deleteChapter(${index})">X√≥a</button>
                        </div>
                    </div>
                    <div class="chapter-content" id="content-${index}">${escapeHtml(chapter.content.substring(0, 200))}${chapter.content.length > 200 ? '...' : ''}</div>
                `;
                chaptersList.appendChild(chapterDiv);
            });

            document.getElementById('previewSection').style.display = 'block';
        }

        function editChapter(index) {
            const chapter = chapters[index];
            const contentDiv = document.getElementById(`content-${index}`);
            
            const textarea = document.createElement('textarea');
            textarea.className = 'editable';
            textarea.value = chapter.content;
            
            contentDiv.innerHTML = '';
            contentDiv.appendChild(textarea);
            
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-edit';
            saveBtn.textContent = 'L∆∞u';
            saveBtn.onclick = () => {
                chapter.content = textarea.value;
                displayChapters();
                generateExportCode();
            };
            
            contentDiv.parentElement.querySelector('.chapter-controls').appendChild(saveBtn);
        }

        function deleteChapter(index) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chapter n√†y?')) {
                chapters.splice(index, 1);
                displayChapters();
                generateExportCode();
            }
        }

        function generateExportCode() {
            let code = 'const chapters = [\n';
            
            chapters.forEach((chapter, index) => {
                const comment = index === 0 ? `  // ${chapter.title}` : '';
                code += `  ${comment}\n`;
                code += `  {\n`;
                code += `    id: "${chapter.id}", page: "${chapter.page}", title: "${chapter.title}",\n`;
                code += `    content: \`\n`;
                code += `      <div class="content-container">\n`;
                
                // Format content - split by paragraphs
                const paragraphs = chapter.content.split(/\n\n+/).filter(p => p.trim());
                paragraphs.forEach(para => {
                    const trimmed = para.trim();
                    if (trimmed) {
                        // Check if it's a heading
                        if (trimmed.match(/^(CH∆Ø∆†NG|TRANG|L·ªúI|GI·ªöI THI·ªÜU|M·ª§C L·ª§C|K·∫æT C·∫§U)/i)) {
                            code += `        <h2 class="h2-indent">${escapeHtml(trimmed)}</h2>\n`;
                        } else {
                            code += `        <p class="p-justify-indent">${escapeHtml(trimmed)}</p>\n`;
                        }
                    }
                });
                
                code += `      </div>\n`;
                code += `    \`\n`;
                code += `  }${index < chapters.length - 1 ? ',' : ''}\n`;
            });
            
            code += '];\n';
            
            document.getElementById('exportCode').value = code;
            document.getElementById('exportSection').style.display = 'block';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard() {
            const code = document.getElementById('exportCode');
            code.select();
            document.execCommand('copy');
            showStatus('ƒê√£ copy code v√†o clipboard!', 'success');
        }

        function showProgress(percentage, text) {
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            progressText.textContent = text;
        }

        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'none';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>

